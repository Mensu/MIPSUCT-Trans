# 外存文件的结构设计

为了提高IO效率，减少系统调用的次数，外存版的实现中所有的数据均是以页为单位进行读写。每次对页内数据进行读写的时候，并不会马上写入文件，而是放在缓冲区中，等待缓冲管理器的调度，再将其从内存交换至外存。实际测试的时候，对一个单一页进行单次的读写，其速度还是比较可观的。

另一点，由于每种存入页内的数据，其长度都是相对固定的，其中节点和记录的数据的长度与数据的维度有关，而叶子节点的大小与数据的维度和N0的值有关，所以这里使用了定长记录和使用位图的方法进行数据的存储。

### 页内结构设计

对于一种数据类型的存储页，其存储的数据大小和数据量都是可以再初始化的时候确定的，但是从文件中读取数据的时候，为了提高效率，页的结尾部分除了位图之外，还有槽的长度（也就是数据的最大长度），以及数据的类型。这里的槽长度类型主要是为了读取的时候能够方便在不知道数据维度的情况下的得到数据的类型和长度，方便解析二进制的数据到对应的类型。

这样一来，每个页中的结构大致是这样的

| 数据段             | 位图                | 数据类型          | 槽长度    |
| --------------- | ----------------- | ------------- | ------ |
| Slot * slot_num | std::vector<bool> | Rid::DataType | size_t |

###  槽的设计

对于不同类型的数据，其存在于内存中的形式，页是不关心的。为了将数据从二进制的形式转换成所需要的数据类型，我们这里使用了一个专门的类管理数据的存取的时候对对应数据类型和二进制形式的装换。

槽的类不会管理内存，其读写的内存块是有对应的页类的缓冲区。为了读写页内二进制数据，先由对应类型的页产生对应类型的槽，如果是新建的槽，页会尝试在当前页内进行槽的分配。