# 页缓冲管理器的设计

页缓冲管理器将缓存一定数量的页面，存放于帧中。它对上提供 ``Put`` 和 ``Get`` 接口，从内存中找到合适的页供用户存放数据，找到指定的页获取数据。当所需页面没缓存在内存中时，管理器才从外存取回所需的页放进内存的帧中，同时将一个不常用的页写回外存，即对页面进行换入换出操作。根据局部性原理，程序接下来即将使用的数据，很有可能来自最近使用的页中。将最近使用的页缓存起来，能一定程度上减少 IO 的开销。

管理器首先需要维护一个索引文件，这里用来存放当前外存中页面的数量。每次初始化时，便从对应的索引文件中获取数量信息，用于新页面生成时钦定页面id。每次结束使用，便将当前的数量信息写回。

其次管理器还要维护一些帧，分配给页面使用，并负责页面的换入换出操作。

## 存放数据

管理器存放数据时，首先要从帧缓存的页面中找到未被写满的继续写，不要轻易创建新页面。考虑到效率问题，这里就不去外存中寻找了。若内存中的页面都被写满，则考虑创建新页面充当未被写满的页面，然后找到一个牺牲的页面换出去，空出一个槽存放新页面。开启该页面的脏位和引用位。

然后，管理器要从未被写满的页面中得到一个空闲的槽，将数据交给它存放，并根据刚才得到的页面和槽，返回一个 Rid。

## 获取数据

管理器根据 Rid 获取数据时，首先是从帧缓存的页面中找找看有没有所需的页面。若没有，则要找到一个牺牲的页面换出去，空出一个槽，然后从外存中读取所需的页面放入该槽。

然后，管理器从所需的页面中得到指定的槽，从槽中取出数据，交给用户。

## 替换策略

这里我们所采用的替换策略是最近最少使用策略（LRU）的变体——时钟替换策略。它与 LRU 有相似的行为，但有较少的开销。

它采用 ``cur`` 变量以环形顺序选择替换帧中缓存的页面。当某一帧被选中时，若其页面的引用位启动，则将其关闭，然后 ``cur`` 变量指向下一帧。否则，可以选择该页进行换出。若转了一圈都没有页面可以换出，则继续转，此时肯定是有一页的引用位是刚才关闭的。这时，便可以将它换出。

